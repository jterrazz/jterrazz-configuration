---
description: Authoritative clean-architecture rules for Node.js / TypeScript server projects (DDD, Ports & Adapters, FP-first, test-driven).
globs:
alwaysApply: true
---

# ðŸ—ï¸ Clean Architecture â€“ Server Side

These rules codify how every backend repository should be structured so that code remains **testable, maintainable, and boring-to-change**. They assume:
â€¢ TypeScript with `strict` on  
â€¢ Functional & declarative style  
â€¢ Dependency Injection via factories  
â€¢ Hexagonal / Ports-and-Adapters layering  
â€¢ Domain-Driven Design terminology

> "Business logic never **knows** nor **cares** how it is called or where data is stored." â€“ Rule #0

---

## 1. Directory Layout (with file-naming rules)

```
src/
  domain/                               # Pure business logic (NO imports from other layers)
    â”œâ”€ entities/                        # *.entity.ts   â†’ article.entity.ts
    â”œâ”€ value-objects/                   # *.vo.ts       â†’ slug.vo.ts
  application/                          # Orchestration + use cases
    â”œâ”€ use-cases/                       # *.use-case.ts â†’ publish-article.use-case.ts
    â”œâ”€ ports/
    â”‚   â”œâ”€ inbound/                     # *.port.ts     â†’ create-article.port.ts
    â”‚   â””â”€ outbound/                    # *.port.ts     â†’ article-repository.port.ts
  infrastructure/                       # Concrete adapters & frameworks
    â”œâ”€ inbound/                         # External entry points
    â”‚   â”œâ”€ controllers/                 # *.controller.ts â†’ create-article.controller.ts
    â”‚   â”œâ”€ routes/                      # *.routes.ts     â†’ article.routes.ts
    â”‚   â”œâ”€ schedulers/                  # *.scheduler.ts  â†’ daily-digest.scheduler.ts
    â”‚   â””â”€ jobs/                        # *.job.ts        â†’ regenerate-preview.job.ts
    â””â”€ outbound/
        â”œâ”€ repositories/                # *.repository.ts â†’ prisma-article.repository.ts
        â”œâ”€ providers/                   # *.provider.ts   â†’ medium.provider.ts
        â””â”€ agents/                      # *.agent.ts      â†’ headline.agent.ts
  di/                                    # Dependency wiring â€“ factories: *.factory.ts, container.ts
  shared/                                # Cross-cutting pure utils: *.ts â†’ date.util.ts
  tests/                                 # Mirrors src hierarchy: *.spec.ts / *.test.ts
```

---

## 2. Naming Conventions

â€¢ Files & folders: **kebab-case**  
â€¢ TypeScript types: **PascalCase**  
â€¢ Ports: `SomethingPort`  
â€¢ Use cases: `VerbNounUseCase` (file `verb-noun.use-case.ts`)  
â€¢ Factories: `somethingFactory` returning concrete port implementations  
â€¢ Controller: `verb-noun.controller.ts`  
â€¢ Value Object: `*.vo.ts`, expose `create()` static factory returning `Result<T>` (never `new`).

---

## 3. Dependency Rules

```
 domain        â†’   âœ–  nothing
 application   â†’   domain
 infrastructureâ†’   application + domain
 di            â†’   infrastructure + application + domain
 shared        â†’   âœ–  nothing
```

---

## 4. Implementation Guidelines

1. **Pure Functions first** â€“ Prefer simple functions; introduce classes only when stateful or polymorphic behaviour is mandatory.
2. **Early returns & guard clauses** â€“ flat control-flow, no deep nesting.
3. **Zod everywhere** â€“
   a. All external data (HTTP, DB, env) validated asap.  
   b. Schemas live alongside the receiving port.
4. **Error strategy**  
   â€¢ Expected errors = typed `Result<E, T>` return values.  
   â€¢ Unexpected = thrown & captured by a framework-level error boundary.
5. **No side effects in domain** â€“ Domain cannot `console.log`, reach DB, or import `process.env`.
6. **Immutability** â€“ Entities/VOs expose mutation as `with*` copy methods.
7. **File size** â€“ â‰¤ 300 lines; split otherwise.

---

## 5. DI Container (di/)

â€¢ Single `container.ts` exposing `makeApp()` factory.  
â€¢ No decorators â€“ use explicit factory functions for tree-shakability.  
â€¢ Factories named `<token>Factory` returning concrete impl.

---

## 6. Testing Strategy ðŸ§ª

| Layer          | Test type       | Location (by convention)                              |
| -------------- | --------------- | ----------------------------------------------------- |
| Domain         | Pure unit       | alongside file â†’ `src/domain/**/__tests__/**`         |
| Application    | Use-case unit   | alongside file â†’ `src/application/**/__tests__/**`    |
| Infrastructure | Contract tests  | alongside file â†’ `src/infrastructure/**/__tests__/**` |
| DI + Framework | E2E/integration | root â†’ `__tests__/e2e/**`                             |

Guidelines:
â€¢ Integration tests MUST assert against fixtures not mocks (e.g. spin up a test DB).

---

## 7. Patterns Catalogue

â€¢ **Agent Pattern** â€“ outbound port for AI / LLM calls (`AskHeadlineAgentPort`).  
â€¢ **Task / Job Pattern** â€“ orchestrate long-running workflows; lives in `infrastructure/inbound/jobs`.  
â€¢ **Configuration Port** â€“ validated env & feature flags; injected, never imported.  
â€¢ **Event Bus Port** â€“ decouple async domain events; injected implementation (e.g. Kafka, in-memory).

---

## 8. Documentation âœ…

Minimum viable comments:

1. Complex domain rules â€“ explain **why** it exists.
2. Ports â€“ 1-liner describing the boundary.
3. Public use-case `execute` â€“ parameters, result, possible errors.  
   Prefer Zod `.describe()` and `/** @description */` jsdoc tags over inline comments.

---

---

## 9. Checklists

Use these before every PR:

- [ ] Domain unchanged by infrastructure/framework refactor.
- [ ] All new external data has a Zod schema.
- [ ] Each file respects layer dependencies.
- [ ] Tests written or updated.
- [ ] Logs carry operation context (request id, correlation id).
