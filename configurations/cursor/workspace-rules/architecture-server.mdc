---
description: Authoritative clean-architecture rules for TypeScript server projects
globs:
alwaysApply: true
---

# ğŸ—ï¸ Clean Architecture â€“ Server Side

These rules codify how every backend repository should be structured so that code remains **testable, maintainable, and boring-to-change**.

> "Business logic never **knows** nor **cares** how it is called or where data is stored." â€“ Rule #0

---

## 1. Directory Layout (with file-naming rules)

```
__tests__/                              # Integration and e2e tests
  â”œâ”€ integration/                       # Cross-layer integration tests
  â”‚   â”œâ”€ use-cases/                     # *.integration.test.ts â†’ publish-article.integration.test.ts
  â”‚   â”œâ”€ repositories/                  # *.integration.test.ts â†’ article-repository.integration.test.ts
  â”‚   â””â”€ fixtures/                      # Test data & database seeds
  â”‚       â”œâ”€ data/                      # *.fixture.ts â†’ article.fixture.ts
  â”‚       â””â”€ database/                  # Migration scripts for test DB
  â””â”€ e2e/                               # End-to-end application tests
      â”œâ”€ api/                           # API endpoint tests
      â”‚   â”œâ”€ articles/                  # *.e2e.test.ts â†’ create-article.e2e.test.ts
      â”‚   â””â”€ health/                    # *.e2e.test.ts â†’ health-check.e2e.test.ts
      â”œâ”€ jobs/                          # Background job tests
      â”‚   â””â”€ *.e2e.test.ts              # â†’ daily-digest.e2e.test.ts
      â”œâ”€ fixtures/                      # E2E test data & mocks
      â”‚   â”œâ”€ servers/                   # Mock external services
      â”‚   â””â”€ scenarios/                 # Complete test scenarios
      â””â”€ helpers/                       # Test utilities & setup
          â”œâ”€ test-server.ts             # Test app factory
          â”œâ”€ database-helper.ts         # DB setup/teardown
          â””â”€ request-helper.ts          # HTTP client utilities

src/
  domain/                               # Pure business logic (NO imports from other layers)
    â”œâ”€ entities/                        # *.entity.ts   â†’ article.entity.ts
    â”œâ”€ value-objects/                   # *.vo.ts       â†’ slug.vo.ts
  application/                          # Orchestration + use cases
    â”œâ”€ use-cases/                       # *.use-case.ts â†’ publish-article.use-case.ts
    â”œâ”€ ports/
    â”‚   â”œâ”€ inbound/                     # *.port.ts     â†’ create-article.port.ts
    â”‚   â””â”€ outbound/                    # *.port.ts     â†’ article-repository.port.ts
  infrastructure/                       # Concrete adapters & frameworks
    â”œâ”€ inbound/                         # External entry points
    â”‚   â”œâ”€ controllers/                 # *.controller.ts â†’ create-article.controller.ts
    â”‚   â”œâ”€ routes/                      # *.routes.ts     â†’ article.routes.ts
    â”‚   â”œâ”€ schedulers/                  # *.scheduler.ts  â†’ daily-digest.scheduler.ts
    â”‚   â””â”€ jobs/                        # *.job.ts        â†’ regenerate-preview.job.ts
    â””â”€ outbound/
        â”œâ”€ repositories/                # *.repository.ts â†’ prisma-article.repository.ts
        â”œâ”€ providers/                   # *.provider.ts   â†’ medium.provider.ts
        â””â”€ agents/                      # *.agent.ts      â†’ headline.agent.ts
  di/                                   # Dependency wiring â€“ factories: *.factory.ts, container.ts
  shared/                               # Cross-cutting pure utils: *.ts â†’ date.util.ts
```

---

## 2. Naming Conventions

â€¢ Files & folders: **kebab-case**
â€¢ TypeScript types: **PascalCase**
â€¢ Ports: `SomethingPort`
â€¢ Use cases: `VerbNounUseCase` (file `verb-noun.use-case.ts`)
â€¢ Factories: `somethingFactory` returning concrete port implementations
â€¢ Controller: `verb-noun.controller.ts`
â€¢ Value Object: `*.vo.ts`, expose `create()` static factory returning `Result<T>` (never `new`).

---

## 3. Dependency Rules

```
 domain        â†’   âœ–  nothing
 application   â†’   domain
 infrastructureâ†’   application + domain
 di            â†’   infrastructure + application + domain
 shared        â†’   âœ–  nothing
```

---

## 4. Implementation Guidelines

1. **Pure Functions first** â€“ Prefer simple functions; introduce classes only when stateful or polymorphic behaviour is mandatory.
2. **Early returns & guard clauses** â€“ flat control-flow, no deep nesting.
3. **Zod everywhere** â€“
   a. All external data (HTTP, DB, env) validated asap.
   b. Schemas live alongside the receiving port.
4. **Error strategy**
   â€¢ Expected errors = typed `Result<E, T>` return values.
   â€¢ Unexpected = thrown & captured by a framework-level error boundary.
5. **No side effects in domain** â€“ Domain cannot `console.log`, reach DB, or import `process.env`.
6. **Immutability** â€“ Entities/VOs expose mutation as `with*` copy methods.
7. **File size** â€“ â‰¤ 300 lines; split otherwise.

---

## 5. DI Container (di/)

â€¢ Single `container.ts` exposing `makeApp()` factory.
â€¢ No decorators â€“ use explicit factory functions for tree-shakability.
â€¢ Factories named `<token>Factory` returning concrete impl.

---

## 6. Patterns Catalogue

â€¢ **Agent Pattern** â€“ outbound port for AI / LLM calls (`AskHeadlineAgentPort`).
â€¢ **Task / Job Pattern** â€“ orchestrate long-running workflows; lives in `infrastructure/inbound/jobs`.
â€¢ **Configuration Port** â€“ validated env & feature flags; injected, never imported.
â€¢ **Event Bus Port** â€“ decouple async domain events; injected implementation (e.g. Kafka, in-memory).

---

## 7. Documentation âœ…

Minimum viable comments:

1. Complex domain rules â€“ explain **why** it exists.
2. Ports â€“ 1-liner describing the boundary.
3. Public use-case `execute` â€“ parameters, result, possible errors.
   Prefer Zod `.describe()` and `/** @description */` jsdoc tags over inline comments.

---

## 8. Best Practices

- âœ… **DO** validate all external data with Zod schemas
- âœ… **DO** respect layer dependency rules
- âœ… **DO** write or update tests for changes
- âœ… **DO** include operation context in logs
- âœ… **DO** use dependency injection via factories

- âŒ **DON'T** let infrastructure changes affect domain
- âŒ **DON'T** import across layer boundaries
- âŒ **DON'T** put side effects in domain layer
- âŒ **DON'T** skip error handling strategy
- âŒ **DON'T** exceed 300 lines per file
