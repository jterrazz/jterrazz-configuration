---
description: Clean-architecture & atomic-design rules for React Native / Expo projects (TypeScript-strict, functional, modular, test-first).
globs:
alwaysApply: true
---

# ğŸ“± Clean Architecture â€“ Mobile (React Native / Expo)

These rules describe how every mobile repository should be organised so that code is **predictable, portable, and a joy to iterate on**.
Assumptions:
â€¢ React Native with Expo  
â€¢ TypeScript strict mode  
â€¢ Functional components & hooks  
â€¢ Dependency Injection via factories/contexts  
â€¢ Atomic Design for UI  
â€¢ Ports & Adapters for business logic / side-effects

> "UI is just a function of state â€“ keep state clean and the UI will follow." â€“ Rule #0

---

## 1. Directory Layout (with file-naming examples)

```
src/
  domain/                                   # Pure business concepts
    â”œâ”€ entities/                            # *.entity.ts      â†’ article.entity.ts
    â”œâ”€ value-objects/                       # *.vo.ts          â†’ slug.vo.ts
    â””â”€ services/                            # *.service.ts     â†’ markdown-to-html.service.ts

  application/                              # Use-cases & ports
    â”œâ”€ use-cases/                           # *.use-case.ts    â†’ toggle-bookmark.use-case.ts
    â””â”€ ports/
        â”œâ”€ inbound/                         # *.port.ts        â†’ toggle-bookmark.port.ts
        â””â”€ outbound/                        # *.port.ts        â†’ bookmark-repository.port.ts

  infrastructure/                           # Platform & side-effects
    â”œâ”€ providers/                           # *.provider.ts    â†’ article.provider.ts (REST/GraphQL)
    â”œâ”€ persistence/                         # *.adapter.ts     â†’ async-storage.adapter.ts
    â”œâ”€ repositories/                        # *.repository.ts  â†’ zustand-bookmark.repository.ts
    â”œâ”€ i18n/                                # locales/*.json, i18n.ts
    â””â”€ navigation/                          # types.ts, navigation.container.tsx

  presentation/                             # UI layer
    â”œâ”€ features/
    â”‚    â””â”€ bookmarks/                      # Bounded UI feature module
    â”‚        â”œâ”€ components/                 # *.tsx           â†’ bookmark-card.tsx
    â”‚        â”œâ”€ hooks/                      # use-*.ts        â†’ use-bookmarks.ts
    â”‚        â””â”€ __tests__/                  # Component / hook tests
    â”œâ”€ shared/
    â”‚    â”œâ”€ components/
    â”‚    â”‚    â”œâ”€ atoms/                     # button.tsx, headline-text.tsx
    â”‚    â”‚    â”œâ”€ molecules/                 # card.tsx
    â”‚    â”‚    â””â”€ organisms/                 # header.tsx
    â”‚    â”œâ”€ hooks/                          # use-toggle.ts
    â”‚    â””â”€ utils/                          # theme.ts, spacing.util.ts
    â”œâ”€ navigation/                          # stack.tsx, tab.tsx
    â””â”€ screens/                             # settings-screen.tsx

  di/                                       # container.ts, factories/*.factory.ts
  types/                                    # global types & React Navigation param lists
  shared/                                   # Cross-cutting pure utils (date, uuid)
  __tests__/e2e/                            # Detox / Playwright mobile flows
```

### Module-By-Feature (optional)

For large apps, wrap the above folders inside `modules/<feature>/` to isolate bounded contexts.

---

## 2. Naming Conventions

â€¢ Folders & files: **kebab-case**  
â€¢ React components: **PascalCase** (named exports)  
â€¢ Hooks: `useSomething.ts`  
â€¢ Ports: `SomethingPort`  
â€¢ Use cases: `verb-noun.use-case.ts` exposing `execute()`  
â€¢ Store: `entity.store.ts`  
â€¢ Provider: `*.provider.ts`  
â€¢ Test file: `*.test.ts[x]` or `*.spec.ts[x]` colocated under `__tests__`.

---

## 3. Dependency Rules

```
 domain           â†’   âœ–  nothing
 application      â†’   domain
 infrastructure   â†’   application + domain
 presentation     â†’   application (never directly infrastructure)
 di               â†’   all layers
 shared           â†’   âœ–  nothing
```

Any violation should fail CI via `@typescript-eslint/no-restricted-imports`.

---

## 4. Implementation Guidelines

1. **Functional & declarative** â€“ Components are pure functions; prefer hooks over class components.
2. **Early returns & guard clauses** â€“ keep render and logic flat.
3. **State strategy**  
   â€¢ Local component state with `useState` when truly local.  
   â€¢ Global cross-screen state via **Zustand** stores behind repositories.
4. **Zod validation** â€“ All external data (API, storage, env) validated at boundaries.
5. **Error handling**  
   â€¢ Expected errors returned as `Result`.  
   â€¢ Unexpected errors caught by an ErrorBoundary (presentation) or global handler (native log).
6. **No side-effects in domain & application** â€“ All I/O lives in providers/persistence.
7. **Platform code** â€“ Use file suffixes `.ios`, `.android`, `.native` when diverging.
8. **File size** â€“ â‰¤ 250 lines for UI, â‰¤ 300 elsewhere; split if larger.

---

## 5. DI Container (di/)

â€¢ One `container.ts` exporting `createContainer()` that wires concrete implementations.  
â€¢ Use React Context (`ContainerProvider`) to expose container to hooks.  
â€¢ Factories named `<token>Factory`.  
â€¢ Never import container directly in production code â€“ always via `useContainer()`.

---

## 6. Testing Strategy ğŸ§ª

| Layer          | Test type          | Location (by convention)                              |
| -------------- | ------------------ | ----------------------------------------------------- |
| Domain         | Pure unit          | alongside file â†’ `src/domain/**/__tests__/**`         |
| Application    | Use-case unit      | alongside file â†’ `src/application/**/__tests__/**`    |
| Infrastructure | Contract / adapter | alongside file â†’ `src/infrastructure/**/__tests__/**` |
| Presentation   | Component / hook   | alongside file â†’ `src/presentation/**/__tests__/**`   |
| E2E            | Detox / Playwright | root â†’ `__tests__/e2e/**`                             |

Guidelines:
â€¢ Avoid mocks in domain tests.  
â€¢ Contract tests spin up fixtures (e.g., mock server) rather than unit stubs.  
â€¢ Use React Native Testing Library for UI; isolate navigation with `renderWithNavigation` helper.

---

## 7. Patterns Catalogue

â€¢ **Atomic Design** â€“ atoms/molecules/organisms for shared components.  
â€¢ **Repository Pattern** â€“ bridges store â†”ï¸ application use cases.  
â€¢ **Provider Pattern** â€“ wraps remote APIs / SDKs / sensors.  
â€¢ **Hook Facade** â€“ each feature exposes a single hook (`useBookmarks`) that glues UI â†”ï¸ use cases.  
â€¢ **Navigation Container** â€“ own folder under `infrastructure/navigation` with typed params.  
â€¢ **Theme / Design-System** â€“ colocated in `presentation/shared` and provided via Context.

---

## 8. Performance Checklist âš¡ï¸

- Memoize heavy list items (`React.memo`).
- Derive arrays with `useMemo`.
- Use `FlashList` or `FlatList` with `getItemLayout`.
- Avoid anonymous functions in JSX.
- Lazy-load screens with `React.lazy` & Suspense + fallback.

---

## 9. Security & Accessibility

â€¢ Secure storage with `expo-secure-store`, never plain AsyncStorage for secrets.  
â€¢ HTTPS only; certificate pinning where required.  
â€¢ Every touchable has `accessibilityLabel`, `accessibilityRole`, proper state.  
â€¢ Support dynamic font sizes via `allowFontScaling` and `StyleSheet.minScaleFactor`.

---

## 10. PR Checklist

- [ ] New external data parsed & validated with Zod.
- [ ] Layer import rules respected.
- [ ] All public types exported from `index.ts`.
- [ ] Tests added/updated (unit or e2e).
- [ ] Screens/components support dark mode & RTL.
- [ ] No `console.log` committed.
