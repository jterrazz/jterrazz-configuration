---
description: Unified testing guidelines ‚Äì structure, naming, skeleton & helpers for unit/integration/e2e tests
globs: **/*.mock.*,**/*.test.*
alwaysApply: false
---

# üß™ Testing Standards ‚Äì Unit & Integration

These rules codify how every test suite should be structured so that tests remain **reliable, readable, and effortless to maintain**.

> "Test behaviour, not implementation ‚Äì focus on what the code does, not how it does it." ‚Äì Rule #0

---

## 1. Directory Layout

```
<repo>
  src/
    components/
      button/
        button.tsx
        __tests__/button.test.tsx      # ‚Üê colocated unit test

  __tests__/                           # ‚Üê root for cross-cutting tests/artifacts
    server-articles-route.integration.test.ts
    fixtures/
      valid-user.fixture.ts
    mocks/
      payment-gateway.mock.ts
    providers/
      ai.openrouter/
        open-router-universal.resolver.ts
```

- **Unit tests** live next to the source file inside a `__tests__/` folder.
- **Integration / E2E** tests live in the root `__tests__/` folder.
- Shared **fixtures**, **mocks** & **resolvers** are grouped under their dedicated sub-folders.

---

## 2. Naming Conventions

| Kind             | Suffix                 | Example                                     |
| ---------------- | ---------------------- | ------------------------------------------- |
| Unit test        | `.test.ts[x]`          | `button.test.tsx`                           |
| Integration test | `.integration.test.ts` | `server-articles-route.integration.test.ts` |
| Fixture          | `.fixture.ts`          | `valid-user.fixture.ts`                     |
| Mock             | `.mock.ts`             | `payment-gateway.mock.ts`                   |
| Test resolver    | `.resolver.ts`         | `open-router-universal.resolver.ts`         |

---

## 3. Test File Skeleton

Every test file **MUST** follow this order:

1. Imports (always use `.js` extension when importing compiled TS).
2. Mocks / stubs.
3. Test data (fixtures).
4. Hooks in order: `beforeAll` ‚Üí `beforeEach` ‚Üí `afterEach` ‚Üí `afterAll`.
5. Test suites (`describe`) & scenarios (`it`).

Example hook ordering for integration context:

```ts
beforeAll(async () => {
  integrationCtx = await createIntegrationContext();
});

beforeEach(async () => {
  await startIntegrationContext(integrationCtx);
});

afterEach(async () => {
  await stopIntegrationContext(integrationCtx);
});
```

---

## 4. Writing Tests

‚Ä¢ Prefer `it` over `test` for clarity.
‚Ä¢ Structure each block with **Given / When / Then** comments ‚Äì use en dashes (‚Äì) for prose descriptions.

```ts
it("returns full JSON response for mixed US articles", async () => {
  // Given ‚Äì a mixed set of US articles
  await ArticleScenarios.createMixedArticles(prisma);

  // When ‚Äì requesting articles
  const res = await executeRequest("/articles?limit=10");

  // Then ‚Äì status OK & expected payload
  expect(res.status).toBe(200);
  expect(res.body.items).toHaveLength(10);
});
```

‚Ä¢ Group related scenarios with nested `describe` blocks (`success ‚Äì happy path`, `error handling`).
‚Ä¢ Use `it.each` for table-driven tests.
‚Ä¢ Focus on **observable behaviour**, not implementation details.

---

## 5. Recommended Toolkit

Always import from the internal toolkit first:

```ts
import { describe, it, expect, mockOf, mockOfDate, msw } from "@jterrazz/test";
```

Key helpers:

- `mockOfDate` ‚Äì deterministic Date mocking (`mockOfDate.set() / reset()`).
- `msw` ‚Äì API mocking with dynamic responses.
- Integration helpers: `createIntegrationContext`, `startIntegrationContext`, `stopIntegrationContext`, `executeRequest`, `executeTask`, `normaliseSnapshot`.

---

## 6. Best Practices

- ‚úÖ **DO** write behaviour-driven test titles
- ‚úÖ **DO** use Given/When/Then structure
- ‚úÖ **DO** reset state between tests
- ‚úÖ **DO** keep unit tests fast (‚â§ 200ms)
- ‚úÖ **DO** use **UPPERCASE** enum values in fixtures
- ‚úÖ **DO** aim for ‚â• 90% meaningful branch coverage

- ‚ùå **DON'T** test implementation details
- ‚ùå **DON'T** use multiple logical assertions per `it`
- ‚ùå **DON'T** skip test data cleanup
- ‚ùå **DON'T** ignore linting rules in test code
- ‚ùå **DON'T** mix expected and unexpected error testing

---

## 7. Testing Strategy by Layer

### Mobile (React Native / Expo)

| Layer          | Test type          | Location (by convention)                              |
| -------------- | ------------------ | ----------------------------------------------------- |
| Domain         | Pure unit          | alongside file ‚Üí `src/domain/**/__tests__/**`         |
| Application    | Use-case unit      | alongside file ‚Üí `src/application/**/__tests__/**`    |
| Infrastructure | Contract / adapter | alongside file ‚Üí `src/infrastructure/**/__tests__/**` |
| Presentation   | Component / hook   | alongside file ‚Üí `src/presentation/**/__tests__/**`   |
| Integration    | Cross-layer        | root ‚Üí `__tests__/integration/**`                     |
| E2E            | Detox / Playwright | root ‚Üí `__tests__/e2e/**`                             |

Guidelines:
‚Ä¢ Avoid mocks in domain tests.
‚Ä¢ Contract tests spin up fixtures (e.g., mock server) rather than unit stubs.
‚Ä¢ Use React Native Testing Library for UI; isolate navigation with `renderWithNavigation` helper.
‚Ä¢ Fixtures & mocks organised in `__tests__/`.

### Server

| Layer          | Test type       | Location (by convention)                              |
| -------------- | --------------- | ----------------------------------------------------- |
| Domain         | Pure unit       | alongside file ‚Üí `src/domain/**/__tests__/**`         |
| Application    | Use-case unit   | alongside file ‚Üí `src/application/**/__tests__/**`    |
| Infrastructure | Contract tests  | alongside file ‚Üí `src/infrastructure/**/__tests__/**` |
| DI + Framework | E2E/integration | root ‚Üí `__tests__/e2e/**`                             |

Guidelines:
‚Ä¢ Integration tests MUST assert against fixtures not mocks (e.g. spin up a test DB).
‚Ä¢ Critical flows covered by integration tests.
