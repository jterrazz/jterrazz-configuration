---
description: Unified testing guidelines â€“ structure, naming, skeleton & helpers for unit/integration/e2e tests
globs: **/*.mock.*,**/*.test.*
alwaysApply: false
---

# ðŸ§ª Testing Standards â€“ Unit & Integration

These rules ensure every repository shares the **same testing ergonomics** so that suites are easy to read, maintain and extend.

---

## 1. Directory Layout

```
<repo>
  src/
    components/
      button/
        button.tsx
        __tests__/button.test.tsx      # â† colocated unit test

  __tests__/                           # â† root for cross-cutting tests/artifacts
    server-articles-route.integration.test.ts
    fixtures/
      valid-user.fixture.ts
    mocks/
      payment-gateway.mock.ts
    providers/
      ai.openrouter/
        open-router-universal.resolver.ts
```

- **Unit tests** live next to the source file inside a `__tests__/` folder.
- **Integration / E2E** tests live in the root `__tests__/` folder.
- Shared **fixtures**, **mocks** & **resolvers** are grouped under their dedicated sub-folders.

---

## 2. Naming Conventions

| Kind             | Suffix                 | Example                                     |
| ---------------- | ---------------------- | ------------------------------------------- |
| Unit test        | `.test.ts[x]`          | `button.test.tsx`                           |
| Integration test | `.integration.test.ts` | `server-articles-route.integration.test.ts` |
| Fixture          | `.fixture.ts`          | `valid-user.fixture.ts`                     |
| Mock             | `.mock.ts`             | `payment-gateway.mock.ts`                   |
| Test resolver    | `.resolver.ts`         | `open-router-universal.resolver.ts`         |

---

## 3. Test File Skeleton

Every test file **MUST** follow this order:

1. Imports (always use `.js` extension when importing compiled TS).
2. Mocks / stubs.
3. Test data (fixtures).
4. Hooks in order: `beforeAll` â†’ `beforeEach` â†’ `afterEach` â†’ `afterAll`.
5. Test suites (`describe`) & scenarios (`it`).

Example hook ordering for integration context:

```ts
beforeAll(async () => {
  integrationCtx = await createIntegrationContext();
});

beforeEach(async () => {
  await startIntegrationContext(integrationCtx);
});

afterEach(async () => {
  await stopIntegrationContext(integrationCtx);
});
```

---

## 4. Writing Tests

â€¢ Prefer `it` over `test` for clarity.
â€¢ Structure each block with **Given / When / Then** comments â€“ use en dashes (â€“) for prose descriptions.

```ts
it("returns full JSON response for mixed US articles", async () => {
  // Given â€“ a mixed set of US articles
  await ArticleScenarios.createMixedArticles(prisma);

  // When â€“ requesting articles
  const res = await executeRequest("/articles?limit=10");

  // Then â€“ status OK & expected payload
  expect(res.status).toBe(200);
  expect(res.body.items).toHaveLength(10);
});
```

â€¢ Group related scenarios with nested `describe` blocks (`success â€“ happy path`, `error handling`).
â€¢ Use `it.each` for table-driven tests.
â€¢ Focus on **observable behaviour**, not implementation details.

---

## 5. Recommended Toolkit

Always import from the internal toolkit first:

```ts
import { describe, it, expect, mockOf, mockOfDate, msw } from "@jterrazz/test";
```

Key helpers:

- `mockOfDate` â€“ deterministic Date mocking (`mockOfDate.set() / reset()`).
- `msw` â€“ API mocking with dynamic responses.
- Integration helpers: `createIntegrationContext`, `startIntegrationContext`, `stopIntegrationContext`, `executeRequest`, `executeTask`, `normaliseSnapshot`.

---

## 6. Best Practices Checklist

- [ ] Behaviour-driven titles (what not how).
- [ ] One logical assertion group per `it` (multiple `expect` allowed).
- [ ] Reset state in hooks to keep tests independent.
- [ ] Keep unit tests fast (â‰¤ 200 ms); integration reasonable.
- [ ] Document expected vs unexpected errors explicitly.
- [ ] Enum values in fixtures are **UPPERCASE**.
- [ ] â‰¥ 90 % meaningful branch coverage.
- [ ] Treat test code with same lint & formatting rules.

---

## 7. Testing Strategy by Layer

### Mobile (React Native / Expo)

| Layer          | Test type          | Location (by convention)                              |
| -------------- | ------------------ | ----------------------------------------------------- |
| Domain         | Pure unit          | alongside file â†’ `src/domain/**/__tests__/**`         |
| Application    | Use-case unit      | alongside file â†’ `src/application/**/__tests__/**`    |
| Infrastructure | Contract / adapter | alongside file â†’ `src/infrastructure/**/__tests__/**` |
| Presentation   | Component / hook   | alongside file â†’ `src/presentation/**/__tests__/**`   |
| Integration    | Cross-layer        | root â†’ `__tests__/integration/**`                     |
| E2E            | Detox / Playwright | root â†’ `__tests__/e2e/**`                             |

Guidelines:
â€¢ Avoid mocks in domain tests.  
â€¢ Contract tests spin up fixtures (e.g., mock server) rather than unit stubs.  
â€¢ Use React Native Testing Library for UI; isolate navigation with `renderWithNavigation` helper.
â€¢ Fixtures & mocks organised in `__tests__/`.

### Server

| Layer          | Test type       | Location (by convention)                              |
| -------------- | --------------- | ----------------------------------------------------- |
| Domain         | Pure unit       | alongside file â†’ `src/domain/**/__tests__/**`         |
| Application    | Use-case unit   | alongside file â†’ `src/application/**/__tests__/**`    |
| Infrastructure | Contract tests  | alongside file â†’ `src/infrastructure/**/__tests__/**` |
| DI + Framework | E2E/integration | root â†’ `__tests__/e2e/**`                             |

Guidelines:
â€¢ Integration tests MUST assert against fixtures not mocks (e.g. spin up a test DB).
â€¢ Critical flows covered by integration tests.
