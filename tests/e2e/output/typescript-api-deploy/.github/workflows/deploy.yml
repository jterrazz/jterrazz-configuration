name: Deploy

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: registry.jterrazz.com
  IMAGE_NAME: my-api-deploy

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yml

  build-and-push:
    name: Build & Push
    needs: ci
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Infisical
        uses: Infisical/secrets-action@v1.0.9
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          domain: https://eu.infisical.com
          project-slug: jterrazz
          env-slug: prod
          secret-path: /infrastructure-apps

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ env.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ env.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.DOCKER_REGISTRY_USERNAME }}
          password: ${{ env.DOCKER_REGISTRY_PASSWORD }}

      - name: Determine image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}

  deploy:
    name: Deploy to Cluster
    needs: build-and-push
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Fetch secrets from Infisical
        uses: Infisical/secrets-action@v1.0.9
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          domain: https://eu.infisical.com
          project-slug: jterrazz
          env-slug: prod
          secret-path: /infrastructure-apps

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ env.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ env.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ env.KUBECONFIG_BASE64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Login to OCI registry
        run: echo "${{ env.DOCKER_REGISTRY_PASSWORD }}" | helm registry login ${{ env.REGISTRY }} --username ${{ env.DOCKER_REGISTRY_USERNAME }} --password-stdin

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "name=prod" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=staging" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via Helm
        run: |
          helm upgrade --install ${{ steps.env.outputs.name }}-${{ env.IMAGE_NAME }} \
            oci://${{ env.REGISTRY }}/charts/app \
            -f .deploy/manifest.yaml \
            --set environment=${{ steps.env.outputs.name }} \
            --set spec.image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.env.outputs.tag }} \
            -n ${{ steps.env.outputs.name }}-${{ env.IMAGE_NAME }} \
            --create-namespace \
            --wait --timeout 3m --atomic

      - name: Clean up old images
        run: |
          TAGS=$(curl -s -u "${{ env.DOCKER_REGISTRY_USERNAME }}:${{ env.DOCKER_REGISTRY_PASSWORD }}" \
            "https://${{ env.REGISTRY }}/v2/${{ env.IMAGE_NAME }}/tags/list" | jq -r '.tags[]? // empty' | grep -v -E '^(latest|v[0-9])' || true)

          for TAG in $TAGS; do
            echo "Deleting old tag: $TAG"
            curl -s -X DELETE -u "${{ env.DOCKER_REGISTRY_USERNAME }}:${{ env.DOCKER_REGISTRY_PASSWORD }}" \
              "https://${{ env.REGISTRY }}/v2/${{ env.IMAGE_NAME }}/manifests/$(curl -s -I -u "${{ env.DOCKER_REGISTRY_USERNAME }}:${{ env.DOCKER_REGISTRY_PASSWORD }}" \
              -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
              "https://${{ env.REGISTRY }}/v2/${{ env.IMAGE_NAME }}/manifests/$TAG" | grep -i docker-content-digest | awk '{print $2}' | tr -d '\r')" || true
          done
